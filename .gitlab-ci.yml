stages:
  - lint
  - test
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - frontend/node_modules/

lint-backend:
  stage: lint
  image: node:16
  script:
    - cd backend
    - npm install
    - npm run lint
  only:
    - branches
    - merge_requests

test-backend:
  stage: test
  image: node:16
  script:
    - cd backend
    - npm install
    - npx jest
  only:
    - branches
    - merge_requests

build-app:
  stage: build
  image: node:16
  script:

    - apt-get update && apt-get install -y zip
    
    # Build frontend
    - cd frontend
    - npm install
    - npm run build
    - cd ..

    # Build backend
    - cd backend
    - npm install
    - cd ..

    # Create deployment structure
    - mkdir -p deploy
    - cp -r backend/* deploy/
    - mkdir -p deploy/public
    - cp -r frontend/build/* deploy/public/

    # Include necessary config files
    - cp -r .ebextensions deploy/ || true
    - cp Procfile deploy/ || true

    # âœ… Zip deploy directory here
    - cd deploy
    - zip -r ../app.zip .
    - cd ..
  only:
    - main

deploy-to-s3:
  stage: deploy
  image: amazonlinux:2
  before_script:
    - yum install -y zip unzip curl
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip
    - ./aws/install
  script:
    - aws s3 cp app.zip s3://$S3_BUCKET_NAME/app-$CI_PIPELINE_ID.zip --region $AWS_REGION
  only:
    - main
